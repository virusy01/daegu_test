<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="snp.app.corp.CorpRepository">

	<!-- 사회적기업 성과지표 조회 -->
	<select id="findSocialKpi" resultType="hashmap">
		SELECT
		L1.KPI_CD AS L1_KPI_CD
		, L1.KPI_NM AS L1_KPI_NM
		, L2.KPI_CD AS L2_KPI_CD
		, L2.KPI_NM AS L2_KPI_NM
		, L3.KPI_CD AS L3_KPI_CD
		, L3.KPI_NM AS L3_KPI_NM
		, L3.IS_GRADE AS IS_GRADE
		, #{p.CORP_SEQ} AS CORP_SEQ
		, #{p.YEAR} AS YEAR
		, null        AS STATUS
		FROM
		(
		SELECT * FROM SOCIAL_KPI WHERE LEVEL = 1
		) L1
		INNER JOIN
		(
		SELECT * FROM SOCIAL_KPI WHERE LEVEL = 2
		) L2 ON (L1.KPI_CD = L2.P_KPI_CD)
		INNER JOIN
		(
		SELECT * FROM SOCIAL_KPI WHERE LEVEL = 3
		) L3 ON (L2.KPI_CD = L3.P_KPI_CD)
		ORDER BY L3.LEVEL, L3.DISP_ORD

	</select>



	<insert id="insertKpi">
		INSERT INTO KPI_RESULT
		(
		CORP_SEQ
		, CORP_TYPE
		, YEAR
		, KPI_CD
		, IS_GRADE
		, RESULT
		, REG_ID
		, REG_DT
		)
		VALUES
		(
		#{p.CORP_SEQ}
		, #{p.CORP_TYPE}
		, #{p.YEAR}
		, #{p.KPI_CD}
		, #{p.IS_GRADE}
		, #{p.RESULT}
		, #{u.userId}
		, now()
		)
	</insert>

	<delete id="deleteKpi">
		DELETE FROM  KPI_RESULT
		WHERE CORP_SEQ = #{p.CORP_SEQ} AND CORP_TYPE = #{p.CORP_TYPE} AND YEAR = #{p.YEAR}
	</delete>




	<select id="findKpi_detail" resultType="hashmap">
		<![CDATA[
		SELECT
		IFNULL(RESULT, 0) AS RESULT
		FROM KPI_RESULT
		WHERE CORP_SEQ = #{p.CORP_SEQ}
		  AND YEAR = #{p.YEAR} AND KPI_CD = #{LEVEL3CODE}
		]]>
	</select>

	<!-- 협동조합 성과지표 조회 -->
	<select id="findCooperationKpi" resultType="hashmap">
		SELECT
		L1.KPI_CD AS L1_KPI_CD
		, L1.KPI_NM AS L1_KPI_NM
		, L2.KPI_CD AS L2_KPI_CD
		, L2.KPI_NM AS L2_KPI_NM
		, L3.KPI_CD AS L3_KPI_CD
		, L3.KPI_NM AS L3_KPI_NM
		, L3.IS_GRADE AS IS_GRADE
		, #{p.CORP_SEQ} AS CORP_SEQ
		, #{p.YEAR} AS YEAR
		, null        AS STATUS
		FROM
		(
		SELECT * FROM COOPERATION_KPI WHERE LEVEL = 1
		) L1
		INNER JOIN
		(
		SELECT * FROM COOPERATION_KPI WHERE LEVEL = 2
		) L2 ON (L1.KPI_CD = L2.P_KPI_CD)
		INNER JOIN
		(
		SELECT * FROM COOPERATION_KPI WHERE LEVEL = 3
		) L3 ON (L2.KPI_CD = L3.P_KPI_CD)
		ORDER BY L3.LEVEL, L3.DISP_ORD

	</select>


	<!-- 협동조합 성과지표 조회 -->
	<select id="findVillageKpi" resultType="hashmap">
		SELECT
		L1.KPI_CD AS L1_KPI_CD
		, L1.KPI_NM AS L1_KPI_NM
		, L2.KPI_CD AS L2_KPI_CD
		, L2.KPI_NM AS L2_KPI_NM
		, L3.KPI_CD AS L3_KPI_CD
		, L3.KPI_NM AS L3_KPI_NM
		, L3.IS_GRADE AS IS_GRADE
		, #{p.CORP_SEQ} AS CORP_SEQ
		, #{p.YEAR} AS YEAR
		, null        AS STATUS
		FROM
		(
		SELECT * FROM VILLAGE_KPI WHERE LEVEL = 1
		) L1
		INNER JOIN
		(
		SELECT * FROM VILLAGE_KPI WHERE LEVEL = 2
		) L2 ON (L1.KPI_CD = L2.P_KPI_CD)
		INNER JOIN
		(
		SELECT * FROM VILLAGE_KPI WHERE LEVEL = 3
		) L3 ON (L2.KPI_CD = L3.P_KPI_CD)
		ORDER BY L3.LEVEL, L3.DISP_ORD

	</select>


	<!-- 성과지표 등급별 분석 - 전체기업-->
	<select id="chartGrade1" resultType="hashmap">
		SELECT 'B' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			 AND RESULT in ('1', '2')
		UNION ALL
		SELECT 'W' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			 AND RESULT in ('3', '4', '5')
		UNION ALL
		SELECT 'G' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			 AND RESULT in ('6', '7')
	</select>

	<!-- 성과지표 등급별 분석 - 사회적기업 -->
	<select id="chartGrade2" resultType="hashmap">
		SELECT 'B' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 1 AND RESULT in ('1', '2')
		UNION ALL
		SELECT 'W' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 1 AND RESULT in ('3', '4', '5')
		UNION ALL
		SELECT 'G' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 1 AND RESULT in ('6', '7')
	</select>

	<!-- 성과지표 등급별 분석 - 마을기업 -->
	<select id="chartGrade3" resultType="hashmap">
		SELECT 'B' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 2 AND RESULT in ('1', '2')
		UNION ALL
		SELECT 'W' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 2 AND RESULT in ('3', '4', '5')
		UNION ALL
		SELECT 'G' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 2 AND RESULT in ('6', '7')
	</select>

	<!-- 성과지표 등급별 분석 - 협동조합-->
	<select id="chartGrade4" resultType="hashmap">
		SELECT 'B' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 3 AND RESULT in ('1', '2')
		UNION ALL
		SELECT 'W' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 3 AND RESULT in ('3', '4', '5')
		UNION ALL
		SELECT 'G' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 3 AND RESULT in ('6', '7')
	</select>




	<!-- 성과지표 항목별 분석 전체기업-->
	<select id="chartKpiAll" resultType="hashmap">
	SELECT 0 AS STATUS, ROUND(AVG(result),1) AS RESULT
	FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			 AND KPI_CD like '01%' AND RESULT != 0

		UNION ALL

		SELECT 1 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			 AND KPI_CD like '02%' AND RESULT != 0

		UNION ALL

			 SELECT 2 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			 AND KPI_CD like '03%' AND RESULT != 0

		UNION ALL

			 SELECT 3 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			 AND KPI_CD like '04%' AND RESULT != 0
	</select>

	<!-- 성과지표 항목별 분석 사회적기업,마을기업,협동조합-->
	<select id="chartKpiEach" resultType="hashmap">
		SELECT 0 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND CORP_TYPE = #{p.CORP_KIND}	AND KPI_CD like '01%' AND RESULT != 0

		UNION ALL

		SELECT 1 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND CORP_TYPE = #{p.CORP_KIND}   AND KPI_CD like '02%' AND RESULT != 0

		UNION ALL

		SELECT 2 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND CORP_TYPE = #{p.CORP_KIND}   AND KPI_CD like '03%' AND RESULT != 0

		UNION ALL

		SELECT 3 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND CORP_TYPE = #{p.CORP_KIND}   AND KPI_CD like '04%' AND RESULT != 0
	</select>



	<!-- 성과지표 지역별 분석 -->
	<select id="chartRegionAll" resultType="hashmap">
	SELECT FOUR.CD AS REGION, IFNULL(THR.RESULT,0) AS RESULT
	FROM
		(SELECT SEC.REGION AS REGION, ROUND(AVG(FIR.RESULT),1) AS RESULT
		FROM
		(
			SELECT CORP_SEQ, RESULT FROM KPI_RESULT
			WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
			OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
			OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			) AS FIR INNER JOIN CORP_INFO AS SEC ON ( FIR.CORP_SEQ = SEC.CORP_SEQ )
		WHERE FIR.RESULT != 0  AND SEC.REGION IS NOT NULL
		GROUP BY REGION) AS THR RIGHT JOIN (SELECT CD, CD_NM FROM CODE WHERE GRP_CD ='REGION' and CD_NM IS NOT NULL) AS FOUR ON ( FOUR.CD = THR.REGION )
	</select>

	<!-- 성과지표 지역별 분석 사회적기업,마을기업,협동조합 -->
	<select id="chartRegionEach" resultType="hashmap">
	SELECT FOUR.CD AS REGION, IFNULL(THR.RESULT,0) AS RESULT
	FROM
		(SELECT SEC.REGION AS REGION, ROUND(AVG(FIR.RESULT),1) AS RESULT
		FROM
		(
			SELECT CORP_SEQ, RESULT FROM KPI_RESULT
			WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
			OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
			OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = #{p.CORP_KIND}
			) AS FIR INNER JOIN CORP_INFO AS SEC ON ( FIR.CORP_SEQ = SEC.CORP_SEQ )
		WHERE FIR.RESULT != 0  AND SEC.REGION IS NOT NULL
		GROUP BY REGION) AS THR RIGHT JOIN (SELECT CD, CD_NM FROM CODE WHERE GRP_CD ='REGION' and CD_NM IS NOT NULL) AS FOUR ON ( FOUR.CD = THR.REGION )
	</select>

    <!-- 성과지표 업종별 분석 -->
    <select id="chartSectorAll" resultType="hashmap">
    SELECT FOUR.CD AS SECTOR, IFNULL(THR.RESULT,0) AS RESULT
        FROM
            (SELECT SEC.SECTOR AS SECTOR, ROUND(AVG(FIR.RESULT),1) AS RESULT
            FROM
            (
                SELECT CORP_SEQ, RESULT FROM KPI_RESULT
                WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
                OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
                OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
                ) AS FIR INNER JOIN CORP_INFO AS SEC ON ( FIR.CORP_SEQ = SEC.CORP_SEQ )
            WHERE FIR.RESULT != 0  AND SEC.SECTOR IS NOT NULL
            GROUP BY SECTOR) AS THR RIGHT JOIN (SELECT CD, CD_NM FROM CODE WHERE GRP_CD ='SECTOR' and CD_NM IS NOT NULL) AS FOUR ON ( FOUR.CD = THR.SECTOR )
    </select>

    <!-- 성과지표 업종별 분석 사회적기업,마을기업,협동조합 -->
    <select id="chartSectorEach" resultType="hashmap">
    SELECT FOUR.CD AS SECTOR, IFNULL(THR.RESULT,0) AS RESULT
        FROM
            (SELECT SEC.SECTOR AS SECTOR, ROUND(AVG(FIR.RESULT),1) AS RESULT
            FROM
            (
                SELECT CORP_SEQ, RESULT FROM KPI_RESULT
                WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
                OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
                OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
                 AND CORP_TYPE = #{p.CORP_KIND}
                ) AS FIR INNER JOIN CORP_INFO AS SEC ON ( FIR.CORP_SEQ = SEC.CORP_SEQ )
            WHERE FIR.RESULT != 0  AND SEC.SECTOR IS NOT NULL
            GROUP BY SECTOR) AS THR RIGHT JOIN (SELECT CD, CD_NM FROM CODE WHERE GRP_CD ='SECTOR' and CD_NM IS NOT NULL) AS FOUR ON ( FOUR.CD = THR.SECTOR )
    </select>

	<!-- 성과지표 유형별 분석 전체기업-->
	<select id="chartAllTotal" resultType="hashmap">
		SELECT 0 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '01%' AND RESULT != 0

		UNION ALL

		SELECT 1 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '02%' AND RESULT != 0

		UNION ALL

		SELECT 2 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '03%' AND RESULT != 0

		UNION ALL

		SELECT 3 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '04%' AND RESULT != 0

		UNION ALL

		SELECT 3 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND RESULT != 0
	</select>

	<!-- 성과지표 유형별 분석 사회적기업-->
	<select id="chartAllSocial" resultType="hashmap">
		SELECT 0 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '01%' AND RESULT != 0 AND CORP_TYPE = 1

		UNION ALL

		SELECT 1 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '02%' AND RESULT != 0 AND CORP_TYPE = 1

		UNION ALL

		SELECT 2 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '03%' AND RESULT != 0 AND CORP_TYPE = 1

		UNION ALL

		SELECT 3 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '04%' AND RESULT != 0 AND CORP_TYPE = 1

		UNION ALL

		SELECT 3 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND RESULT != 0 AND CORP_TYPE = 1
	</select>

	<!-- 성과지표 유형별 분석 마을기업-->
	<select id="chartAllVillage" resultType="hashmap">
		SELECT 0 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '01%' AND RESULT != 0 AND CORP_TYPE = 2

		UNION ALL

		SELECT 1 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '02%' AND RESULT != 0 AND CORP_TYPE = 2

		UNION ALL

		SELECT 2 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '03%' AND RESULT != 0 AND CORP_TYPE = 2

		UNION ALL

		SELECT 3 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '04%' AND RESULT != 0 AND CORP_TYPE = 2

		UNION ALL

		SELECT 3 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND RESULT != 0 AND CORP_TYPE = 2
	</select>


	<!-- 성과지표 유형별 분석 협동조합-->
	<select id="chartAllCooperation" resultType="hashmap">
		SELECT 0 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '01%' AND RESULT != 0 AND CORP_TYPE = 3

		UNION ALL

		SELECT 1 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '02%' AND RESULT != 0 AND CORP_TYPE = 3

		UNION ALL

		SELECT 2 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '03%' AND RESULT != 0 AND CORP_TYPE = 3

		UNION ALL

		SELECT 3 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND KPI_CD like '04%' AND RESULT != 0 AND CORP_TYPE = 3

		UNION ALL

		SELECT 3 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND RESULT != 0 AND CORP_TYPE = 3
	</select>

    <!-- 성과지표 기업별 분석 사회적기업/마을기업/협동조합-->
    <select id="gridCorpEach" resultType="hashmap">
        SELECT
            CASE KRY.CORP_TYPE WHEN 1 THEN '사회적기업'
            WHEN 2 THEN '마을기업'
            ELSE '협동조합' END AS CORP_TYPE
            , KRY.CORP_SEQ AS CORP_SEQ
            , (SELECT CORP_NM FROM CORP_INFO WHERE CORP_SEQ = KRY.CORP_SEQ) AS CORP_NM
            , ROUND(KRY.RESULT,1) AS GRADE_RESULT
            , ROUND(KRN.RESULT,1) AS RATE_RESULT
        FROM
        ( SELECT CI.CORP_TYPE, CI.CORP_SEQ, AVG(KR.RESULT) AS RESULT FROM (SELECT * FROM KPI_RESULT WHERE IS_GRADE = 'Y' AND RESULT !=0 ) AS KR
                    RIGHT JOIN CORP_INFO AS CI ON ( KR.CORP_SEQ = CI.CORP_SEQ ) GROUP BY CORP_TYPE, CORP_SEQ  ) AS KRY
        LEFT JOIN
        ( SELECT CI.CORP_TYPE, CI.CORP_SEQ, AVG(KR.RESULT) AS RESULT FROM  (SELECT * FROM KPI_RESULT WHERE IS_GRADE = 'N' AND RESULT !=0) AS KR
                    RIGHT JOIN CORP_INFO AS CI ON ( KR.CORP_SEQ = CI.CORP_SEQ )  GROUP BY CORP_TYPE, CORP_SEQ) AS KRN
        ON ( KRY.CORP_SEQ = KRN.CORP_SEQ )
        WHERE KRN.CORP_TYPE = #{p.CORP_KIND}
        ORDER BY CORP_NM
    </select>

    <!-- 성과지표 기업별 분석 전체-->
    <select id="gridCorpAll" resultType="hashmap">
        SELECT
        CASE KRY.CORP_TYPE WHEN 1 THEN '사회적기업'
        WHEN 2 THEN '마을기업'
        ELSE '협동조합' END AS CORP_TYPE
        , KRY.CORP_SEQ AS CORP_SEQ
        , (SELECT CORP_NM FROM CORP_INFO WHERE CORP_SEQ = KRY.CORP_SEQ) AS CORP_NM
        , ROUND(KRY.RESULT,1) AS GRADE_RESULT
        , ROUND(KRN.RESULT,1) AS RATE_RESULT
        FROM
        ( SELECT CI.CORP_TYPE, CI.CORP_SEQ, AVG(KR.RESULT) AS RESULT FROM (SELECT * FROM KPI_RESULT WHERE  IS_GRADE = 'Y' AND RESULT !=0 ) AS KR
        RIGHT JOIN CORP_INFO AS CI ON ( KR.CORP_SEQ = CI.CORP_SEQ ) GROUP BY CORP_TYPE, CORP_SEQ  ) AS KRY
        LEFT JOIN
        ( SELECT CI.CORP_TYPE, CI.CORP_SEQ, AVG(KR.RESULT) AS RESULT FROM  (SELECT * FROM KPI_RESULT WHERE IS_GRADE = 'N' AND RESULT !=0) AS KR
        RIGHT JOIN CORP_INFO AS CI ON ( KR.CORP_SEQ = CI.CORP_SEQ )  GROUP BY CORP_TYPE, CORP_SEQ) AS KRN
        ON ( KRY.CORP_SEQ = KRN.CORP_SEQ )
        ORDER BY CORP_NM
    </select>

	<!-- 성과지표 업종별 분석 : 노동통합형, 문제해결형, 지역사회혁신형, 고용창출형 -->
	<select id="chartType" resultType="hashmap">
		SELECT FOUR.CD AS TYPE, IFNULL(THR.RESULT,0) AS RESULT
        FROM
            (SELECT SEC.LEG_TYPE2 AS LEG_TYPE2, ROUND(AVG(FIR.RESULT),1) AS RESULT
            FROM
            (
                SELECT CORP_SEQ, RESULT FROM KPI_RESULT
                WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
                OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
                OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
                ) AS FIR INNER JOIN CORP_INFO AS SEC ON ( FIR.CORP_SEQ = SEC.CORP_SEQ )
			WHERE FIR.RESULT != 0  AND SEC.LEG_TYPE2 IS NOT NULL
			GROUP BY LEG_TYPE2) AS THR RIGHT JOIN (SELECT CD, CD_NM FROM CODE WHERE GRP_CD ='LEG_TYPE2' and CD_NM IS NOT NULL) AS FOUR ON ( FOUR.CD = THR.LEG_TYPE2 )
	</select>


</mapper>
