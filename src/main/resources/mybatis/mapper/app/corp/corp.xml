<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="snp.app.corp.CorpRepository">

	<!-- 협동조합 성과지표 조회 -->
	<select id="findSocialKpi" resultType="hashmap">
		SELECT
		L1.KPI_CD AS L1_KPI_CD
		, L1.KPI_NM AS L1_KPI_NM
		, L2.KPI_CD AS L2_KPI_CD
		, L2.KPI_NM AS L2_KPI_NM
		, L3.KPI_CD AS L3_KPI_CD
		, L3.KPI_NM AS L3_KPI_NM
		, L3.IS_GRADE AS IS_GRADE
		, #{p.CORP_SEQ} AS CORP_SEQ
		, #{p.YEAR} AS YEAR
		, null        AS STATUS
		FROM
		(
		SELECT * FROM SOCIAL_KPI WHERE LEVEL = 1
		) L1
		INNER JOIN
		(
		SELECT * FROM SOCIAL_KPI WHERE LEVEL = 2
		) L2 ON (L1.KPI_CD = L2.P_KPI_CD)
		INNER JOIN
		(
		SELECT * FROM SOCIAL_KPI WHERE LEVEL = 3
		) L3 ON (L2.KPI_CD = L3.P_KPI_CD)
		ORDER BY L3.LEVEL, L3.DISP_ORD

	</select>



	<insert id="insertKpi">
		INSERT INTO KPI_RESULT
		(
		CORP_SEQ
		, CORP_TYPE
		, YEAR
		, KPI_CD
		, RESULT
		, REG_ID
		, REG_DT
		)
		VALUES
		(
		#{p.CORP_SEQ}
		, #{p.CORP_TYPE}
		, #{p.YEAR}
		, #{p.KPI_CD}
		, #{p.RESULT}
		, #{u.userId}
		, now()
		)
	</insert>

	<delete id="deleteKpi">
		DELETE FROM  KPI_RESULT
		WHERE CORP_SEQ = #{p.CORP_SEQ} AND CORP_TYPE = #{p.CORP_TYPE} AND YEAR = #{p.YEAR}
	</delete>




	<select id="findKpi_detail" resultType="hashmap">
		<![CDATA[
		SELECT
		IFNULL(RESULT, 0) AS RESULT
		FROM KPI_RESULT
		WHERE CORP_SEQ = #{p.CORP_SEQ}
		  AND YEAR = #{p.YEAR} AND KPI_CD = #{LEVEL3CODE}
		]]>
	</select>

	<!-- 협동조합 성과지표 조회 -->
	<select id="findCooperationKpi" resultType="hashmap">
		SELECT
		L1.KPI_CD AS L1_KPI_CD
		, L1.KPI_NM AS L1_KPI_NM
		, L2.KPI_CD AS L2_KPI_CD
		, L2.KPI_NM AS L2_KPI_NM
		, L3.KPI_CD AS L3_KPI_CD
		, L3.KPI_NM AS L3_KPI_NM
		, L3.IS_GRADE AS IS_GRADE
		, #{p.CORP_SEQ} AS CORP_SEQ
		, #{p.YEAR} AS YEAR
		, null        AS STATUS
		FROM
		(
		SELECT * FROM COOPERATION_KPI WHERE LEVEL = 1
		) L1
		INNER JOIN
		(
		SELECT * FROM COOPERATION_KPI WHERE LEVEL = 2
		) L2 ON (L1.KPI_CD = L2.P_KPI_CD)
		INNER JOIN
		(
		SELECT * FROM COOPERATION_KPI WHERE LEVEL = 3
		) L3 ON (L2.KPI_CD = L3.P_KPI_CD)
		ORDER BY L3.LEVEL, L3.DISP_ORD

	</select>


	<!-- 협동조합 성과지표 조회 -->
	<select id="findVillageKpi" resultType="hashmap">
		SELECT
		L1.KPI_CD AS L1_KPI_CD
		, L1.KPI_NM AS L1_KPI_NM
		, L2.KPI_CD AS L2_KPI_CD
		, L2.KPI_NM AS L2_KPI_NM
		, L3.KPI_CD AS L3_KPI_CD
		, L3.KPI_NM AS L3_KPI_NM
		, L3.IS_GRADE AS IS_GRADE
		, #{p.CORP_SEQ} AS CORP_SEQ
		, #{p.YEAR} AS YEAR
		, null        AS STATUS
		FROM
		(
		SELECT * FROM VILLAGE_KPI WHERE LEVEL = 1
		) L1
		INNER JOIN
		(
		SELECT * FROM VILLAGE_KPI WHERE LEVEL = 2
		) L2 ON (L1.KPI_CD = L2.P_KPI_CD)
		INNER JOIN
		(
		SELECT * FROM VILLAGE_KPI WHERE LEVEL = 3
		) L3 ON (L2.KPI_CD = L3.P_KPI_CD)
		ORDER BY L3.LEVEL, L3.DISP_ORD

	</select>










	<!-- 성과지표 등급별 분석 - 전체기업-->
	<select id="chartGrade1" resultType="hashmap">
		SELECT 'B' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			 AND RESULT in ('1', '2')
		UNION ALL
		SELECT 'W' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			 AND RESULT in ('3', '4', '5')
		UNION ALL
		SELECT 'G' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			 AND RESULT in ('6', '7')
	</select>

	<!-- 성과지표 등급별 분석 - 사회적기업 -->
	<select id="chartGrade2" resultType="hashmap">
		SELECT 'B' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 1 AND RESULT in ('1', '2')
		UNION ALL
		SELECT 'W' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 1 AND RESULT in ('3', '4', '5')
		UNION ALL
		SELECT 'G' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 1 AND RESULT in ('6', '7')
	</select>

	<!-- 성과지표 등급별 분석 - 마을기업 -->
	<select id="chartGrade3" resultType="hashmap">
		SELECT 'B' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 2 AND RESULT in ('1', '2')
		UNION ALL
		SELECT 'W' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 2 AND RESULT in ('3', '4', '5')
		UNION ALL
		SELECT 'G' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 2 AND RESULT in ('6', '7')
	</select>

	<!-- 성과지표 등급별 분석 - 협동조합-->
	<select id="chartGrade4" resultType="hashmap">
		SELECT 'B' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 3 AND RESULT in ('1', '2')
		UNION ALL
		SELECT 'W' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 3 AND RESULT in ('3', '4', '5')
		UNION ALL
		SELECT 'G' AS STATUS, count(*) AS COUNT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			AND CORP_TYPE = 3 AND RESULT in ('6', '7')
	</select>




	<!-- 성과지표 항목별 분석 전체기업-->
	<select id="chartKpiAll" resultType="hashmap">
	SELECT 0 AS STATUS, ROUND(AVG(result),1) AS RESULT
	FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			 AND KPI_CD like '01%' AND RESULT != 0

		UNION ALL

		SELECT 1 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			 AND KPI_CD like '02%' AND RESULT != 0

		UNION ALL

			 SELECT 2 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			 AND KPI_CD like '03%' AND RESULT != 0

		UNION ALL

			 SELECT 3 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
				OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
			 AND KPI_CD like '04%' AND RESULT != 0
	</select>

	<!-- 성과지표 항목별 분석 사회적기업,마을기업,협동조합-->
	<select id="chartKpiEach" resultType="hashmap">
		SELECT 0 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND CORP_TYPE = #{p.CORP_KIND}	AND KPI_CD like '01%' AND RESULT != 0

		UNION ALL

		SELECT 1 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND CORP_TYPE = #{p.CORP_KIND}   AND KPI_CD like '02%' AND RESULT != 0

		UNION ALL

		SELECT 2 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND CORP_TYPE = #{p.CORP_KIND}   AND KPI_CD like '03%' AND RESULT != 0

		UNION ALL

		SELECT 3 AS STATUS, ROUND(AVG(result),1) AS RESULT
		FROM kpi_result
		WHERE ( ( CORP_TYPE = 1 AND KPI_CD in ( SELECT KPI_CD FROM SOCIAL_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 2 AND KPI_CD in ( SELECT KPI_CD FROM VILLAGE_KPI WHERE IS_GRADE = 'Y' ) )
		OR ( CORP_TYPE = 3 AND KPI_CD in ( SELECT KPI_CD FROM COOPERATION_KPI WHERE IS_GRADE = 'Y' ) ) )
		AND CORP_TYPE = #{p.CORP_KIND}   AND KPI_CD like '04%' AND RESULT != 0
	</select>



	<!-- 성과지표 지역별 분석 데모용-->
	<select id="chartDemo3" resultType="hashmap">
		SELECT COL2 as RESULT
		FROM DEMO_TBL
		WHERE SEQ = 3 and COL1= #{p.CORP_KIND}
		ORDER BY COL3
	</select>

</mapper>
