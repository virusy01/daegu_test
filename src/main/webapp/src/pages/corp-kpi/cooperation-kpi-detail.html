<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-location/iron-location.html">
<link rel="import" href="/src/components/behaviors/behavior-loader.html">

<dom-module id="cooperation-kpi-detail">
<template>
	<iron-location id="location"></iron-location>

	<iron-ajax id="getData" method="get" headers='{"X-Requested-With": "XMLHttpRequest"}'
			 on-request="_startLoader"
			   url="/api/corp/cooperationkpi"
		      on-response="_drawChart">
	</iron-ajax>

	<div class="row">
		<div class="col-xs-12 text-right">
			<button type="button" on-tap="_toList" class="btn btn-sm btn-default">목록으로</button>
		</div>
	</div>
	<div class="horizontal-margin-20"></div>
	<div class="row">
		<div class="col-xs-12 text-right">
			<label>양호 :</label>
			<button type="ponter" class="legend-good"> </button>
			<label>주의 :</label>
			<button type="ponter" class="legend-warning"> </button>
			<label>위험 :</label>
			<button type="ponter" class="legend-danger"> </button>
			<label> 해당없음 : N/A</label>
		</div>
	</div>


	<table id="tableKPI" class="table-kpi table-bordered">
		<thead>
			<tr>
				<th>대분류</th>
				<th>중분류</th>
				<th>소분류</th>
				<th>결과</th>
				<th width="150">평가등급</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
	</table>


</template>
<script>
Polymer({
	is: 'cooperation-kpi-detail',

	behaviors: [Lunch.LoaderBehavior],

	properties: {
		adminMode: {
			type: Boolean,
			value: false
		},
		id: {
			type: Number,
			observer: '_callAPI'
		},
		_corpSeq: {
			type: Number,
			value: function() {
				return parseInt(sessionStorage.corpSeq);
			}
		},
		_data: {
			type: Array,
			value: function() {
				return [];
			}
		},

		_grade: {
			type: Object,
			value: function() {
				return {B: 'legend-danger', W: 'legend-warning', G: 'legend-good'};
			}
		},
	},

	_callAPI: function() {
		this.$.getData.params = {
			YEAR: 2016,
			CORP_SEQ: this.id ? this.id : this._corpSeq
		};
		
		this.$.getData.generateRequest();
	},

	_drawChart: function(e) {
		this._data = e.currentTarget.lastResponse;

		var table = this.$.tableKPI.querySelector('tbody');
		var tr, th, td;
		var startOfRow = true;
		var startOf2ndDepth = true;
		var prevRowNum, prev2ndDepth;
		var row;

		Polymer.dom(table).innerHTML = '';

		for (var key in this._data) {
			row = this._data[key];
			tr = document.createElement('tr');

			if (prevRowNum != row.L1_KPI_CD)
				startOfRow = true;

			if (startOfRow) {
				startOfRow = false;

				td = document.createElement('td');
				td.setAttribute('rowspan', this._getRowCount(key, 'L1_KPI_CD'));
				td.innerHTML = row.L1_KPI_NM;
				Polymer.dom(tr).appendChild(td);
			}

			if (prev2ndDepth != row.L2_KPI_CD)
				startOf2ndDepth = true;

			if (startOf2ndDepth) {
				startOf2ndDepth = false;

				td = document.createElement('td');
				td.setAttribute('rowspan', this._getRowCount(key, 'L2_KPI_CD'));
				td.innerHTML = row.L2_KPI_NM;
				Polymer.dom(tr).appendChild(td);
			}

			td = document.createElement('td');
			td.setAttribute('class', 'text-left');
			td.innerHTML = row.L3_KPI_NM;
			Polymer.dom(tr).appendChild(td);

            td = document.createElement('td');
            if(row.RESULT)
		    	td.innerHTML = row.RESULT;
            else
                td.innerHTML = '0';
            Polymer.dom(tr).appendChild(td);

			td = document.createElement('td');
			td.setAttribute('class', 'pointer');
			Polymer.dom(tr).appendChild(td);

            switch (row.RESULT) {
                case '1':
                case '2':
                    var legend = document.createElement('div');
                    legend.setAttribute('class', this._grade['B']);
                    Polymer.dom(td).appendChild(legend);
                    break;
                case '3':
                case '4':
                case '5':
                    var legend = document.createElement('div');
                    legend.setAttribute('class', this._grade['W']);
                    Polymer.dom(td).appendChild(legend);
                    break;
                case '6':
                case '7':
                    var legend = document.createElement('div');
                    legend.setAttribute('class', this._grade['G']);
                    Polymer.dom(td).appendChild(legend);
                    break;
                default:
                    td.innerHTML = 'N/A';
                    break;
            }


			Polymer.dom(table).appendChild(tr);

			prevRowNum = row.L1_KPI_CD;
			prev2ndDepth = row.L2_KPI_CD;
		}

		this._stopLoader();
	},

	_getRowCount: function(rowKey, column) {
		var cd = this._data[rowKey][column];
		var count = 0;

		while (this._data[rowKey] && this._data[rowKey][column] == cd) {
			count++;
			rowKey++;
		}

		return count;
	},


	_toList: function(e) {
		this.$.location.path = '/app/cooperation-kpi/list/';
	},	
});
</script>
</dom-module>
