<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/src/components/common/normal-select.html">
<link rel="import" href="/src/components/behaviors/behavior-loader.html">

<dom-module id="page-analytics-all">
	<template>
		<iron-ajax id="getData" method="get" headers='{"X-Requested-With": "XMLHttpRequest"}'
				   on-request="_startLoader"
				   url="/api/hq/analytics/all"
				   on-response="_drawChart">
		</iron-ajax>

		<div class="page-header">
			<h2>기업 유형별 성과지표 분석 <small>Corporation Type Analytics</small></h2>
		</div>

		<div class="row">
			<div class="col-xs-12">
				<canvas id="barChart"  width="500" height="450"></canvas>
			</div>
		</div>
	</template>
	<script>
        Polymer({
            is: 'page-analytics-all',

            behaviors: [Lunch.LoaderBehavior],

            properties: {

                data: {
                    type: Array,
                    value: function() {
                        return [];
                    }
                },

                _myBarChart: Object,
            },

            attached: function() {
                this._drawChart();
            },

            _drawChart: function() {

                var data = {
                    labels: ['사회적기업', '협동조합', '마을기업', '전체평균'],
                    datasets: [
                        {
                            type: 'bar',
                            label: '사회적/경제적 성과',
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1,
                            data: [3.1, 6.5, 5.8, 5.1]
                        },
                        {
                            type: 'bar',
                            label: '기업 건전성',
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            data: [4.3, 5.2, 4.2, 4.6]
                        },
                        {
                            type: 'bar',
                            label: '사회가치 창출 역량',
                            backgroundColor: 'rgba(255, 206, 86, 0.5)',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 1,
                            data: [2.4, 6.3, 5.3, 4.9]
                        },
                        {
                            type: 'bar',
                            label: '비즈니스 역량',
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            data: [5.2, 2.3, 3.1, 3.3]
                        },
                        {
                            type: 'bar',
                            label: '전체 평균',
                            backgroundColor: 'rgba(255, 80, 40, 0.8)',
                            borderColor: 'rgba(255, 80, 40, 1)',
                            borderWidth: 1,
                            data: [3.4, 5.5, 4.1, 4.4]
                        },
                    ]
                };

                this._myBarChart = new Chart(this.$.barChart, {
                    type: 'bar',
                    data: data,
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    callback: function(value) {
                                        return accounting.formatNumber(value);
                                    },
                                    fontSize: 16,
                                    beginAtZero: true,
                                    stacked: true
                                }
                            }],
                            xAxes: [{
                                ticks: {
                                    fontSize: 16
                                }
                            }]
                        },

                        legend: {
                            display: true,
                            labels: {
                                fontSize : 16
                            }
                        },
                        animation: {
                            duration: 500,
                            easing: "easeOutQuart",
                            onComplete: function () {
                                var ctx = this.chart.ctx;
                                ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontFamily, 'normal', Chart.defaults.global.defaultFontFamily);
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'bottom';

                                this.data.datasets.forEach(function (dataset) {
                                    for (var i = 0; i < dataset.data.length; i++) {
                                        var model = dataset._meta[Object.keys(dataset._meta)[0]].data[i]._model,
                                            scale_max = dataset._meta[Object.keys(dataset._meta)[0]].data[i]._yScale.maxHeight;
                                        ctx.fillStyle = '#444';
                                        var y_pos = model.y - 5;
                                        // Make sure data value does not get overflown and hidden
                                        // when the bar's value is too close to max value of scale
                                        // Note: The y value is reverse, it counts from top down
                                        if ((scale_max - model.y) / scale_max >= 0.93)
                                            y_pos = model.y + 20;
                                        ctx.fillText(dataset.data[i], model.x, y_pos);
                                    }
                                });
                            }
                        },
                        maintainAspectRatio: false
                    }
                });

                this._stopLoader();
            },


        });
	</script>
</dom-module>

