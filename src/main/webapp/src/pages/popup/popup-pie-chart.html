<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/src/components/behaviors/behavior-loader.html">

<dom-module id="popup-pie-chart">
<template>
<iron-ajax id="getData" method="get" headers='{"X-Requested-With": "XMLHttpRequest"}'
		 on-request="_startLoader"
		   url="/api/corp/yearly-report/kpiCompare"
	      on-response="_drawChart">
</iron-ajax>

<div class="panel panel-default pie-chart">
	<div class="panel-heading">
		<div class="row">
			<div class="col-xs-10">
				<h3 class="panel-title">자부담 공공급식 가치</h3>
			</div>
			<div class="col-xs-2 text-right">
			    <button type="button" on-tap="_closePopup" class="btn btn-xs btn-primary">
				<i class="fa fa-times" aria-hidden="true"></i>
			    </button>
			</div>
		</div>
	</div>
	<div class="panel-body">
		<div class="row">
			<div class="col-xs-12">
				<canvas id="pieChart" width="550" height="320"></canvas>
			</div>
		</div>
	</div>
</div>
</template>
<script>
Polymer({
	is: 'popup-pie-chart',

	behaviors: [Lunch.LoaderBehavior],
	
	properties: {
		data: {
			type: Array,
			value: function() {
				return [];
			}
		},
		row: String,
		corpSeq: Number,
		year: Number,
		_labels: {
			type: Object,
			value: function() {
				return {B: '위험', W: '주의', G: '양호'};
			}
		},
	},

	observers: [
		'_fetchData(row, corpSeq, year)'
	],

	_fetchData: function() {
		this.$.getData.params = {
			CORP_SEQ: this.corpSeq,
			YEAR: this.year,
			L3_KPI_CD: this.row
		};

		this.$.getData.generateRequest();	
	},

	_drawChart: function(e) {
		this._data = e.currentTarget.lastResponse;
		var labels = [];
		var data = [];

		for (var key in this._data) {
			labels.push(this._labels[this._data[key].STATUS]);
			data.push(this._data[key].COUNT);
		}

		var data = {
		    labels: labels,
		    datasets: [
			{
			    data: data,
			    backgroundColor: [
				"#FF6384",
				"#36A2EB",
				"#FFCE56"
			    ],
			    hoverBackgroundColor: [
				"#FF6384",
				"#36A2EB",
				"#FFCE56"
			    ]
			}]
		};

		var myLineChart = new Chart(this.$.pieChart, {
		    type: 'pie',
		    data: data,
		    options: {
			    tooltips: {
				    callbacks: {
					    label: function(items, data) {
						    return accounting.formatNumber(data.datasets[0].data[items.datasetIndex]);
					    }
				    }
			    },
			    animation: {
				    onComplete: function(animation) {
					var ctx = this.chart.ctx;
				      ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontFamily, 'normal', Chart.defaults.global.defaultFontFamily);
				      ctx.textAlign = 'center';
				      ctx.textBaseline = 'bottom';

				      this.data.datasets.forEach(function (dataset) {

					for (var i = 0; i < dataset.data.length; i++) {
					  var model = dataset._meta[Object.keys(dataset._meta)[0]].data[i]._model,
					      total = dataset._meta[Object.keys(dataset._meta)[0]].total,
					      mid_radius = model.innerRadius + (model.outerRadius - model.innerRadius)/2,
					      start_angle = model.startAngle,
					      end_angle = model.endAngle,
					      mid_angle = start_angle + (end_angle - start_angle)/2;

					  var x = mid_radius * Math.cos(mid_angle);
					  var y = mid_radius * Math.sin(mid_angle);

					  ctx.fillStyle = '#fff';
					  if (i == 3){ // Darker text color for lighter background
					    ctx.fillStyle = '#444';
					  }
					  var percent = String(Math.round(dataset.data[i]/total*100)) + "%";
					  ctx.fillText(dataset.data[i], model.x + x, model.y + y);
					  // Display percent in another line, line break doesn't work for fillText
					  ctx.fillText(percent, model.x + x, model.y + y + 15);
					}
				      });

				    }
			    }
		    }
		});

		this._stopLoader();
	},

	_drawSegmentValues: function() {
	},

	_closePopup: function(e) {
		this.classList.add('hide');
	},
});
</script>
</dom-module>

