<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/src/components/behaviors/behavior-loader.html">

<dom-module id="popup-bar-chart">
<template>

<iron-ajax id="getData" method="get" headers='{"X-Requested-With": "XMLHttpRequest"}'
		 on-request="_startLoader"
		   url="/api/corp/yearly-report/kpiCompare"
	      on-response="_drawChart">
</iron-ajax>

<div class="panel panel-default bar-chart">
	<div class="panel-heading">
		<div class="row">
			<div class="col-xs-10">
				<h3 class="panel-title">매출액</h3>
			</div>
			<div class="col-xs-2 text-right">
			    <button type="button" on-tap="_closePopup" class="btn btn-xs btn-primary">
				<i class="fa fa-times" aria-hidden="true"></i>
			    </button>
			</div>
		</div>
	</div>
	<div class="panel-body">
		<div class="row">
			<div class="col-xs-12">
				<canvas id="barChart" width="550" height="320"></canvas>
			</div>
		</div>
	</div>
</div>
</template>
<script>
Polymer({
	is: 'popup-bar-chart',

	behaviors: [Lunch.LoaderBehavior],

	properties: {
		data: {
			type: Array,
			value: function() {
				return [];
			}
		},
		row: String,
		corpSeq: Number,
		year: Number,
	},

	observers: [
		'_fetchData(row, corpSeq, year)'
	],

	_fetchData: function() {
		this.$.getData.params = {
			CORP_SEQ: this.corpSeq,
			YEAR: this.year,
			L3_KPI_CD: this.row
		};

		this.$.getData.generateRequest();	
	},

	_drawChart: function(e) {
		this._data = e.currentTarget.lastResponse;
		var avg = this._data[3].RESULT;

		var data = {
		    labels: ['최소값', 'MY', '최대값'], 
		    datasets: [
			{
			    type: 'bar',
			    label: '매출액',
			    backgroundColor: [
				'rgba(255, 99, 132, 0.5)',
				'rgba(54, 162, 235, 0.5)',
				'rgba(255, 206, 86, 0.5)',
				'rgba(75, 192, 192, 0.5)',
				'rgba(153, 102, 255, 0.5)',
				'rgba(255, 159, 64, 0.5)'
			    ],
			    borderColor: [
				'rgba(255,99,132,1)',
				'rgba(54, 162, 235, 1)',
				'rgba(255, 206, 86, 1)',
				'rgba(75, 192, 192, 1)',
				'rgba(153, 102, 255, 1)',
				'rgba(255, 159, 64, 1)'
			    ],
			    borderWidth: 1,
			    data: [this._data[0].RESULT, this._data[1].RESULT, this._data[2].RESULT],
			},
			{
			    type: 'line',
			    label: "Avg",
			    fill: false,
			    lineTension: 0.1,
			    backgroundColor: "rgba(75,192,192,1)",
			    borderColor: "rgba(75,192,192,1)",
			    borderCapStyle: 'butt',
			    borderDash: [],
			    borderDashOffset: 0.0,
			    borderJoinStyle: 'miter',
			    pointBorderColor: "rgba(75,192,192,1)",
			    pointBackgroundColor: "#fff",
			    pointBorderWidth: 1,
			    pointHoverRadius: 5,
			    pointHoverBackgroundColor: "rgba(75,192,192,1)",
			    pointHoverBorderColor: "rgba(220,220,220,1)",
			    pointHoverBorderWidth: 2,
			    pointRadius: 1,
			    pointHitRadius: 10,
			    data: [avg, avg, avg],

			}
		    ]
		};

		var myLineChart = new Chart(this.$.barChart, {
		    type: 'bar',
		    data: data,
		    options: {
			    scales: {
				    yAxes: [{
					    ticks: {
						    callback: function(value) {
							    return accounting.formatNumber(value);
						    }
					    }
				    }]
			    },
			    tooltips: {
				    callbacks: {
					    label: function(items) {
						    return accounting.formatNumber(items.yLabel);
					    }
				    }
			    },
			    legend: {
				    display: false
			    }
		    }
		});

		this._stopLoader();
	},

	_closePopup: function(e) {
		this.classList.add('hide');
	},
});
</script>
</dom-module>
