<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/src/components/behaviors/behavior-loader.html">
<link rel="import" href="/src/pages/popup/popup-pie-chart.html">

<dom-module id="page-overall-kpi">
<template>
	<iron-ajax id="getData" method="get" headers='{"X-Requested-With": "XMLHttpRequest"}'
			 on-request="_startLoader"
			   url="/api/hq/yearly-report/kpiAll"
		      on-response="_drawChart">
	</iron-ajax>

	<div class="page-header">
		<h2>전체 성과지표 조회 <small>OVERALL KPI</small></h2>
	</div>

	<div class="horizontal-margin-20"></div>
	
	<div class="vertically-scrollable">
		<table id="tableKPI" class="table-overall-kpi table-bordered">
			<thead>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>

	<popup-pie-chart id="pieChart" class="hide"></popup-pie-chart>
	
</template>
<script>
Polymer({
	is: 'page-overall-kpi',

	behaviors: [Lunch.LoaderBehavior],

	properties: {
		_corpSeq: {
			type: Number,
			value: function() {
				return parseInt(sessionStorage.corpSeq);
			}
		},
		_data: {
			type: Array,
			value: function() {
				return [];
			}
		},
		_grade: {
			type: Object,
			value: function() {
				return {B: 'legend-danger', W: 'legend-warning', G: 'legend-good'};
			}
		},
		_defaultHeader: {
			type: Array,
			value: function() {
				return [
					{CENTER_NM: '성과지표'},
					{CENTER_NM: '세부 성과지표'},
					{CENTER_NM: '측정 방법'}
				];
			}
		},
	},

	attached: function() {
		this.$.getData.params = {
			YEAR: moment().year()
		};
		
		this.$.getData.generateRequest();
	},

	_drawChart: function(e) {
		this._data = e.currentTarget.lastResponse;

		this._drawHeader();

		var table = this.$.tableKPI.querySelector('tbody');
		var tr, th, td;
		var startOfRow = true;
		var startOf2ndDepth = true;
		var prevRowNum, prev2ndDepth;
		var row;

		for (var key in this._data.kpiAll) {
			row = this._data.kpiAll[key];
			tr = document.createElement('tr');

			if (prevRowNum != row.L1_KPI_NM)
				startOfRow = true;

			if (startOfRow) {
				startOfRow = false;

				td = document.createElement('td');
				td.setAttribute('rowspan', this._getRowCount(key, 'L1_KPI_NM'));
				td.innerHTML = row.L1_KPI_NM;
				Polymer.dom(tr).appendChild(td);
			}

			if (prev2ndDepth != row.L2_KPI_NM)
				startOf2ndDepth = true;

			if (startOf2ndDepth) {
				startOf2ndDepth = false;

				td = document.createElement('td');
				td.setAttribute('rowspan', this._getRowCount(key, 'L2_KPI_NM'));
				td.innerHTML = row.L2_KPI_NM;
				Polymer.dom(tr).appendChild(td);
			}

			td = document.createElement('td');
			td.setAttribute('class', 'text-left');
			td.innerHTML = row.L3_KPI_NM;
			Polymer.dom(tr).appendChild(td);

			for (var i = 0; i < this._data.corps.length; i++) {
				td = document.createElement('td');
				td.setAttribute('row', row.L3_KPI_CD);
				td.setAttribute('corpseq', this._data.corps[i].CORP_SEQ);
				Polymer.dom(tr).appendChild(td);

				switch (row[this._data.corps[i].CORP_SEQ]) {
					case 'B':
					case 'W':
					case 'G':
						var legend = document.createElement('div');
						legend.setAttribute('class', this._grade[row[this._data.corps[i].CORP_SEQ]]);
						Polymer.dom(td).appendChild(legend);
						this.listen(td, 'tap', '_showPieChart');
						break;
					default:
						var legend = document.createElement('div');
						legend.setAttribute('class', this._grade['B']);
						Polymer.dom(td).appendChild(legend);
						break;
				}
			}
						
			Polymer.dom(table).appendChild(tr);

			prevRowNum = row.L1_KPI_NM;
			prev2ndDepth = row.L2_KPI_NM;
		}

		this._stopLoader();
	},

	_drawHeader: function() {
		var table = this.$.tableKPI;
		var head = table.querySelector('thead');
		var body = table.querySelector('tbody');
		var headerLabels = this._defaultHeader.concat(this._data.corps);

		var tr = document.createElement('tr');
		var th;
		for (var i = 0; i < headerLabels.length; i++) {
			var label = headerLabels[i];
			th = document.createElement('th');
			th.innerHTML = label.CENTER_NM;
			Polymer.dom(tr).appendChild(th);
		}

		Polymer.dom(head).appendChild(tr);
	},

	_getRowCount: function(rowKey, column) {
		var cd = this._data.kpiAll[rowKey][column];
		var count = 0;

		while (this._data.kpiAll[rowKey] && this._data.kpiAll[rowKey][column] == cd) {
			count++;
			rowKey++;
		}

		return count;
	},

	_showPieChart: function(e) {
		var chart = this.$.pieChart;
		chart.setAttribute('row', e.currentTarget.getAttribute('row'));
		chart.setAttribute('corp-seq', e.currentTarget.getAttribute('corpseq'));
		chart.setAttribute('year', moment().year());

		chart.classList.remove('hide');
	},
});
</script>
</dom-module>
