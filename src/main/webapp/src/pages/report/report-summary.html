<link rel="import" href="/bower_components/iron-form/iron-form.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/src/components/common/number-input.html">
<link rel="import" href="/src/components/behaviors/behavior-grid.html">
<link rel="import" href="/src/components/behaviors/behavior-loader.html">

<dom-module id="report-summary">
<template>
	<iron-ajax id="getData" method="get" headers='{"X-Requested-With": "XMLHttpRequest"}'
			 on-request="_startLoader"
			   url="/api/corp/monthly-report/summary"
		      on-response="_assignData">
	</iron-ajax>
	<div class="horizontal-margin-20"></div>


	<form id="gridForm" is="iron-form"
	      class="form-horizontal">

	<div class="row">
		<div class="col-xs-12 text-right">
			<template is="dom-if" if="{{adminMode}}">
				<button type="button" on-tap="_downloadExcel" class="btn btn-sm btn-default">엑셀 다운로드</button>
			</template>
		</div>
	</div>
	
	<div id="alert" class="alert alert-dismissible hide" role="alert"></div>

	<div class="horizontal-margin-20"></div>

	<div class="panel panel-default">
		<div class="panel-heading">
			<h4>요약1</h4>
		</div>
		<table id="table1" class="table table-bordered">
			<thead>
				<tr>
					<th>요약</th>
					<th rowspan='2'>공공급식수</th>
					<th rowspan='2'>매출합계</th>
					<th colspan='2'>매출액</th>
					<th rowspan='2'>유료비율</th>
					<th rowspan='2'>자부담급식수</th>
				</tr>
				<tr>
					<th>월</th>
					<th>공공급식</th>
					<th>유료급식</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
			<tfoot>
			</tfoot>
		</table>
	</div>

	<div class="horizontal-margin-20"></div>

	<div class="panel panel-default">
		<div class="panel-heading">
			<h4>요약2</h4>
		</div>
		<table id="table2a" class="table table-bordered">
			<thead>
				<tr>
					<th>요약</th>
					<th colspan='3'>수익A</th>
					<th colspan='5'>비용</th>
				</tr>
				<tr>
					<th>월</th>
					<th>공공매출</th>
					<th>유료매출</th>
					<th>기타 수익</th>
					<th>인건비</th>
					<th>식재료비</th>
					<th>일반운영비</th>
					<th>감가상각비</th>
					<th>영업외비용</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
			<tfoot>
			</tfoot>
		</table>
		<table id="table2b" class="table table-bordered">
			<thead>
				<tr>
					<th>요약</th>
					<th colspan='4'>수익B</th>
					<th colspan='2'>적립금</th>
				</tr>
				<tr>
					<th>월</th>
					<th>인건비</th>
					<th>사업개발비</th>
					<th>운영비</th>
					<th>기차</th>
					<th>월퇴직적립금</th>
					<th>자립적립금</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
			<tfoot>
			</tfoot>
		</table>
	</div>

	<div class="horizontal-margin-20"></div>

	<div class="panel panel-default">
		<div class="panel-heading">
			<h4>요약3</h4>
		</div>
		<table id="table3a" class="table table-bordered">
			<thead>
				<tr>
					<th>요약</th>
					<th>ㅏ립도A</th>
					<th>자립도B</th>
					<th>수익A</th>
					<th>수익B</th>
					<th>총비용</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
			<tfoot>
			</tfoot>
		</table>
		<table id="table3b" class="table table-bordered">
			<thead>
				<tr>
					<th>요약</th>
					<th>인원</th>
					<th>평균인건비</th>
					<th>인건비율</th>
					<th>총재료비율</th>
					<th>영업이익</th>
					<th>순이익</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
			<tfoot>
			</tfoot>
		</table>
	</div>
	<div class="horizontal-margin-20"></div>


	<div class="panel panel-default">
		<div class="panel-heading">
			<h4>요약4</h4>
		</div>
		<table id="table4a" class="table table-bordered">
			<thead>
				<tr>
					<th>요약</th>
					<th>일반고용</th>
					<th>일반고용%</th>
					<th>노동부</th>
					<th>노동부%</th>
					<th>자활근로</th>
					<th>자활근로%</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
			<tfoot>
			</tfoot>
		</table>
		<table id="table4b" class="table table-bordered">
			<thead>
				<tr>
					<th>요약</th>
					<th>합계</th>
					<th>취약계층</th>
					<th>취약계층비율</th>
					<th>여서</th>
					<th>여성비율</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
			<tfoot>
			</tfoot>
		</table>

	</div>

	</form>

</template>
<script>
Polymer({
	is: 'report-summary',

	behaviors: [Lunch.GridBehavior, Lunch.LoaderBehavior],
			
	properties: {
		year: Number,
		adminMode: {
			type: Boolean,
			value: false
		},
		apiTrigger: {
			type: Boolean,
			value: false
		},
		_corpSeq: {
			type: Number,
			value: function() {
				return parseInt(sessionStorage.corpSeq);
			}
		},
		_data1: {
			type: Array,
			value: function() {
				return [];
			}
		},
		_data2: {
			type: Array,
			value: function() {
				return [];
			}
		},
		_data3: {
			type: Array,
			value: function() {
				return [];
			}
		},
		_data4: {
			type: Array,
			value: function() {
				return [];
			}
		},
		_guide1: {
			type: Array,
			value: function() {
				return [
					'PUBLIC_MEALS_CNT',
					'SUMMARY_TOTAL_SALES',
					'PUBLIC_TOTAL_SALES',
					'PAID_TOTAL_SALES',
					'PAID_TOTAL_RATE',
					'PUBLIC_SELF_PAY',
				];
			}
		},
		_guide2a: {
			type: Array,
			value: function() {
				return [
					'PUBLIC_TOTAL_SALES',
					'PAID_TOTAL_SALES',
					'SUPPORT_ETC_TOTAL',
					'COSTS_LABOR',
					'COSTS_FOOD_MATERIAL',
					'COSTS_MANAGEMENT',
					'COSTS_DEPRECIATION',
					'COSTS_NON_SALES',
				];
			}
		},
		_guide2b: {
			type: Array,
			value: function() {
				return [
					'SUPPORT_GOV_LABOR_COSTS',
					'SUPPORT_GOV_BIZ_DEVELOPMENT',
					'SUPPORT_GOV_MANAGEMENT',
					'SUPPORT_GOV_ETC',
					'COSTS_RETIRE_SAVING',
					'COSTS_INDEPENDENCY_SAVING',
				];
			}
		},
		_guide3a: {
			type: Array,
			value: function() {
				return [
					'SUMMARY_INDEPEND_POWER_A',
					'SUMMARY_INDEPEND_POWER_B',
					'PROFIT_A',
					'PROFIT_B',
					'COSTS_TOTAL',
				];
			}
		},
		_guide3b: {
			type: Array,
			value: function() {
				return [
					'EMP_SUM',
					'COSTS_LABOR_AVG',
					'COSTS_LABOR_RATE',
					'COSTS_FOOD_MATERIAL_RATE',
					'SUMMARY_OP_PROFIT',
					'SUMMARY_NET_PROFIT',	
				];
			}
		},
		_guide4a: {
			type: Array,
			value: function() {
				return [
					'EMP_GENERAL_SUM',
					'EMP_GENERAL_RATE',
					'EMP_GOV_SUM',
					'EMP_GOVRATE',
					'EMP_SELF_SUPPORT_SUM',
					'EMP_SELF_SUPPORT_RATE',
				];
			}
		},
		_guide4b: {
			type: Array,
			value: function() {
				return [
					'EMP_SUM',
					'EMP_WEAK_SUM',
					'EMP_WEAK_RATE',
					'EMP_FEMALE_SUM',
					'EMP_FEMALE_RATE',
				];
			}
		},
	},

	observers: [
		'requestData(apiTrigger, _corpSeq, year)'
	],

	created: function() {
		this._adminAPIURL = '/api/hq/monthly-report/summary';
	},

	_assignData: function(e) {
		var data = e.target.lastResponse;

		if (data) {
			this._data1 = data.summary1;
			this._data2 = data.summary2;
			this._data3 = data.summary3;
			this._data4 = data.summary4;

			this._assignDataToTable('table1', this.$.table1, this._data1, this._guide1);

			this._assignDataToTable('table2a', this.$.table2a, this._data2, this._guide2a);
			this._assignDataToTable('table2b', this.$.table2b, this._data2, this._guide2b);

			this._assignDataToTable('table3a', this.$.table3a, this._data3, this._guide3a);
			this._assignDataToTable('table3b', this.$.table3b, this._data3, this._guide3b);

			this._assignDataToTable('table4a', this.$.table4a, this._data4, this._guide4a);
			this._assignDataToTable('table4b', this.$.table4b, this._data4, this._guide4b);

			this._stopLoader();
		}
	},

	_assignDataToTable: function(prefix, table, data, guide) { 
		var body = table.querySelector('tbody');
		var tr, th, td, value;
		var input;
		var total = {};

		Polymer.dom(body).innerHTML = '';

		for (var i = 0; i < 12; i++) {
			tr = document.createElement('tr');	
			th = document.createElement('th');
			Polymer.dom(th).innerHTML = data[i].MONTH;

			Polymer.dom(body).appendChild(tr);
			Polymer.dom(tr).appendChild(th);

			for (var attribute in guide) {
				td = document.createElement('td');
				Polymer.dom(tr).appendChild(td);

				value = data[i][guide[attribute]];

				input = document.createElement('number-input');
				input.setAttribute('transparent', true);
				input.setAttribute('id', prefix + '_' + guide[attribute] + i);
				input.setAttribute('name', prefix + '_' + guide[attribute]);
				input.setAttribute('value', value);
				input.setAttribute('readonly', true);
				Polymer.dom(td).appendChild(input);

				if (!total[guide[attribute]])
					total[guide[attribute]] = 0;

				total[guide[attribute]] += value;
			}
		}	

		this._drawFooter(prefix, table, total);
	},

	_drawFooter: function(prefix, table, total) {

		var foot = table.querySelector('tfoot');
		Polymer.dom(foot).innerHTML = '';

		if (prefix != 'table4a' && prefix != 'table4b') {
			// total
			tr = document.createElement('tr');
			th = document.createElement('th');
			Polymer.dom(th).innerHTML = '합계';
			Polymer.dom(tr).appendChild(th);
			Polymer.dom(foot).appendChild(tr);

			for (var t in total) {
				td = document.createElement('td');
				td.setAttribute('id', 'total_' + prefix + '_' + t);
				td.innerHTML = accounting.formatNumber(total[t]);

				Polymer.dom(tr).appendChild(td);
			}
		}

		if (!this._hideSum) {
			// sum
			tr = document.createElement('tr');
			th = document.createElement('th');
			Polymer.dom(th).innerHTML = '월평균';
			Polymer.dom(tr).appendChild(th);
			Polymer.dom(foot).appendChild(tr);

			for (var t in total) {
				td = document.createElement('td');
				td.setAttribute('id', 'sum_' + prefix + '_' + t);
				td.innerHTML = accounting.formatNumber(total[t] / 12);

				Polymer.dom(tr).appendChild(td);
			}
		}

	},

	_clearData: function() {
		Polymer.dom(this.$.table1.querySelector('tbody')).innerHTML = '';
		Polymer.dom(this.$.table1.querySelector('tfoot')).innerHTML = '';

		Polymer.dom(this.$.table2a.querySelector('tbody')).innerHTML = '';
		Polymer.dom(this.$.table2a.querySelector('tfoot')).innerHTML = '';
		Polymer.dom(this.$.table2b.querySelector('tbody')).innerHTML = '';
		Polymer.dom(this.$.table2b.querySelector('tfoot')).innerHTML = '';

		Polymer.dom(this.$.table3a.querySelector('tbody')).innerHTML = '';
		Polymer.dom(this.$.table3a.querySelector('tfoot')).innerHTML = '';
		Polymer.dom(this.$.table3b.querySelector('tbody')).innerHTML = '';
		Polymer.dom(this.$.table3b.querySelector('tfoot')).innerHTML = '';

		Polymer.dom(this.$.table4a.querySelector('tbody')).innerHTML = '';
		Polymer.dom(this.$.table4a.querySelector('tfoot')).innerHTML = '';
		Polymer.dom(this.$.table4b.querySelector('tbody')).innerHTML = '';
		Polymer.dom(this.$.table4b.querySelector('tfoot')).innerHTML = '';
	},

});
</script>
</dom-module>
