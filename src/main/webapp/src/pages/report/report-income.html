<link rel="import" href="/bower_components/iron-form/iron-form.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/src/components/common/number-input.html">
<link rel="import" href="/src/components/behaviors/behavior-grid.html">
<link rel="import" href="/src/components/behaviors/behavior-loader.html">

<dom-module id="report-income">
<template>
	<iron-ajax id="getData" method="get" headers='{"X-Requested-With": "XMLHttpRequest"}'
			 on-request="_startLoader"
			   url="/api/corp/monthly-report/income"
		      on-response="_assignData">
	</iron-ajax>
	<div class="horizontal-margin-20"></div>


	<form id="gridForm" is="iron-form"
	      content-type="application/json"
	      method="post" 
	      action="/api/corp/monthly-report/income"
       	      on-iron-form-presubmit="_parseDataBeforeSubmit"
	      on-iron-form-response="_submitResponse"	
	      class="form-horizontal">

	<div class="row">
		<div class="col-xs-12 text-right">
			<template is="dom-if" if="{{adminMode}}">
				<button type="button" on-tap="_downloadExcel" class="btn btn-sm btn-default">엑셀 다운로드</button>
			</template>

			<template is="dom-if" if="{{!adminMode}}">
			<button type="button" on-tap="_resetData" class="btn btn-sm btn-default">되돌리기</button>
			<button type="button" on-tap="_submitForm" class="btn btn-sm btn-primary">저장</button>
			</template>
		</div>
	</div>
	
	<div id="alert" class="alert alert-dismissible hide" role="alert"></div>

	<div class="horizontal-margin-20"></div>

	<div class="panel panel-default">
		<div class="panel-heading">
			<h4>공공급식</h4>
		</div>
		<div class="panel-body">
			<div class="row">
				<div class="col-xs-4">
					<span class="report-total">
						정부지원 공공급식수  
						<span class="badge">[[_totalGovernmentSupply]]</span>
					</span>
				</div>
				<div class="col-xs-4">
					<span class="report-total">
						자부담 공공급식수 
						<span class="badge">[[_totalSelfSupply]]</span>
					</span>
				</div>
			</div>
		</div>

		<table id="tableGovSupply" class="table table-bordered">
			<thead>
				<tr>
					<th rowspan='2'>공공급식</th>
					<th colspan='7'>식수</th>
				</tr>
				<tr>
					<th colspan='2'>아동</th>
					<th colspan='3'>노인</th>
					<th rowspan='2'>기타</th>
				</tr>
				<tr>
					<th>월</th>
					<th>도시락형</th>
					<th>이동급식형</th>
					<th>도시락</th>
					<th>밑반찬형</th>
					<th>홀운영</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
			<tfoot>
			</tfoot>	
		</table>
		<table id="tableSelfSupply" class="table table-bordered">
			<thead>
				<tr>
					<th rowspan='2'>공공급식</th>
					<th colspan='6'>매출액</th>
					<th rowspan='3'>자부담 식수</th>
				</tr>
				<tr>
					<th colspan='2'>아동</th>
					<th colspan='3'>노인</th>
					<th rowspan='2'>기타</th>
				</tr>
				<tr>
					<th>월</th>
					<th>도시락형</th>
					<th>이동급식형</th>
					<th>도시락</th>
					<th>밑반찬형</th>
					<th>홀운영</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
			<tfoot>
			</tfoot>
		</table>

	</div>

	<div class="horizontal-margin-20"></div>

	<div class="panel panel-default">
		<div class="panel-heading">
			<h4>유료급식</h4>
		</div>
		<table id="tablePaidFood" class="table table-bordered">
			<thead>
				<tr>
					<th>유료급식</th>
					<th colspan='8'>매출액</th>
				</tr>
				<tr>
					<th>월</th>
					<th>도시락</th>
					<th>케이터링</th>
					<th>예비군</th>
					<th>학교급식</th>
					<th>홀운영(위탁)</th>
					<th>특산물</td>
					<th>하이닉스후원</th>
					<th>기타</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
			<tfoot>
			</tfoot>
		</table>
	</div>

	<div class="horizontal-margin-20"></div>

	<div class="panel panel-default">
		<div class="panel-heading">
			<h4>지원금</h4>
		</div>

		<table id="tableSupport" class="table table-bordered">
			<thead>
				<tr>
					<th>지원금</th>
					<th colspan='5'>외부 공적지원금(노동부,보건복지부,지자체 등의 지원금)</th>
					<th colspan='3'>기타(수입)</th>
				</tr>
				<tr>
					<th>월</th>
					<th>인건비</th>
					<th>사업개발비</th>
					<th>운영비</th>
					<th>기타</th>
					<th>비고</td>
					<th>후원금</th>
					<th>재단지원금</th>
					<th>기타</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
			<tfoot>
			</tfoot>
		</table>
	</div>

	</form>

</template>
<script>
Polymer({
	is: 'report-income',

	behaviors: [Lunch.GridBehavior, Lunch.LoaderBehavior],

	properties: {
		year: Number,
		adminMode: {
			type: Boolean,
			value: false
		},
		apiTrigger: {
			type: Boolean,
			value: false
		},
		_corpSeq: {
			type: Number,
			value: function() {
				return parseInt(sessionStorage.corpSeq);
			}
		},
		_totalGovernmentSupply: {
			type: Number,
			value: 0,
		},
		_totalSelfSupply: {
			type: Number,
			value: 0
		},
		_dataPublicMeals: {
			type: Array,
			value: function() {
				return [];
			}
		},
		_dataPaidMeals: {
			type: Array,
			value: function() {
				return [];
			}
		},
		_dataSupport: {
			type: Array,
			value: function() {
				return [];
			}
		},
		_guideGov: {
			type: Array,
			value: function() {
				return [
					'KIDS_LUNCH_BOX',
					'KIDS_LUNCH_CAR',
					'SILVER_LUNCH_BOX',
					'SILVER_SIDE_DISH',
					'SILVER_LUNCH_ROOM',
					'ETC',
				];
			}
		},
		_guideSelf: {
			type: Array,
			value: function() {
				return [
					'SALES_KIDS_LUNCH_BOX',
					'SALES_KIDS_LUNCH_CAR',
					'SALES_SILVER_LUNCH_BOX',
					'SALES_SILVER_SIDE_DISH',
					'SALES_SILVER_LUNCH_ROOM',
					'SALES_ETC',
					'SELF_PAY',
				];
			}
		},
		_guidePaidFood: {
			type: Array,
			value: function() {
				return [
					'LUNCH_BOX',
					'CATERING',
					'RESERVE_FORCES',
					'SCHOOL',
					'LUNCH_ROOM',
					'SPECIALTY',
					'HYNIX_SUPPORT',
					'ETC',
				];
			}
		},
		_guideSupport: {
			type: Array,
			value: function() {
				return [
					'GOV_LABOR_COSTS',
					'GOV_BIZ_DEVELOPMENT',
					'GOV_MANAGEMENT',
					'GOV_ETC',
					'GOV_NOTE',
					'EXT_DONATION',
					'EXT_FOUNDATION_SUPPORT',
					'EXT_ETC',
				];
			}
		},
	},

	observers: [
		'requestData(apiTrigger, _corpSeq, year)'
	],

	created: function() {
		this._adminAPIURL = '/api/hq/monthly-report/income';
	},

	_assignData: function(e) {
		var data = e.target.lastResponse;

		if (data) {
			this._dataPublicMeals = data.publicMeals;
			this._dataPaidMeals = data.paidMeals;
			this._dataSupport = data.support;

			this._assignDataToTable('water', this.$.tableGovSupply, this._dataPublicMeals, this._guideGov);
			this._assignDataToTable('income', this.$.tableSelfSupply, this._dataPublicMeals, this._guideSelf);

			this._refreshHeaderTotal();

			this._assignDataToTable('paid', this.$.tablePaidFood, this._dataPaidMeals, this._guidePaidFood);
			this._assignDataToTable('support', this.$.tableSupport, this._dataSupport, this._guideSupport);
			this._stopLoader();
		}
	},

	_clearData: function() {
		// gov
		Polymer.dom(this.$.tableGovSupply.querySelector('tbody')).innerHTML = '';
		Polymer.dom(this.$.tableGovSupply.querySelector('tfoot')).innerHTML = '';

		// self
		Polymer.dom(this.$.tableSelfSupply.querySelector('tbody')).innerHTML = '';
		Polymer.dom(this.$.tableSelfSupply.querySelector('tfoot')).innerHTML = '';

		// paid
		Polymer.dom(this.$.tablePaidFood.querySelector('tbody')).innerHTML = '';
		Polymer.dom(this.$.tablePaidFood.querySelector('tfoot')).innerHTML = '';

		// support
		Polymer.dom(this.$.tableSupport.querySelector('tbody')).innerHTML = '';
		Polymer.dom(this.$.tableSupport.querySelector('tfoot')).innerHTML = '';
	},

	_refreshHeaderTotal: function() {
		// gov
		var prefix = 'water';
		var guide = this._guideGov;
		var total = 0;

		for (var i = 0; i < guide.length; i++) {
			total += accounting.unformat(this.$$('#total_' + prefix + '_' + guide[i]).innerHTML);
		}

		this._totalGovernmentSupply = accounting.formatNumber(total);

		// self
		prefix = 'income';

		this._totalSelfSupply = accounting.unformat(this.$$('#total_' + prefix + '_SELF_PAY').innerHTML);
	},

	_parseDataBeforeSubmit: function(e) {
		var data = this.$.gridForm.serialize();
		var parsedDataPublicMeals = [];
		var parsedDataPaidMeals = [];
		var parsedDataSupport = [];

		for (var i = 0; i < 12; i++) {
			for (var key in data) {
				var keySplit = key.split('_');
				var category = keySplit[0];
				var insertKey = keySplit.splice(1, keySplit.length).join('_');
				var insertValue = accounting.unformat(data[key][i]);

				switch (category) {
					case 'water':
					case 'income':
						if (!parsedDataPublicMeals[i])
							parsedDataPublicMeals[i] = {};
						parsedDataPublicMeals[i][insertKey] = insertValue;
						break;
					case 'paid':
						if (!parsedDataPaidMeals[i])
							parsedDataPaidMeals[i] = {};
						parsedDataPaidMeals[i][insertKey] = insertValue;
						break;
					case 'support':
						if (!parsedDataSupport[i])
							parsedDataSupport[i] = {};
						parsedDataSupport[i][insertKey] = insertValue;
						break;
				}
			}
			parsedDataPublicMeals[i]['YEAR'] = this.year;
			parsedDataPaidMeals[i]['YEAR'] = this.year;
			parsedDataSupport[i]['YEAR'] = this.year;

			parsedDataPublicMeals[i]['CORP_SEQ'] = this._corpSeq;
			parsedDataPaidMeals[i]['CORP_SEQ'] = this._corpSeq;
			parsedDataSupport[i]['CORP_SEQ'] = this._corpSeq;

			parsedDataPublicMeals[i]['MONTH'] = i + 1; 
			parsedDataPaidMeals[i]['MONTH'] = i + 1;
			parsedDataSupport[i]['MONTH'] = i + 1;
		}

	   	this.$.gridForm.request.body = {
			publicMeals: parsedDataPublicMeals,
			paidMeals: parsedDataPaidMeals,
			support: parsedDataSupport
		};
	},

});
</script>
</dom-module>
