<link rel="import" href="/bower_components/iron-form/iron-form.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/src/components/common/number-input.html">
<link rel="import" href="/src/components/behaviors/behavior-grid.html">
<link rel="import" href="/src/components/behaviors/behavior-loader.html">

<dom-module id="report-expense">
<template>
	<div class="horizontal-margin-20"></div>

	<iron-ajax id="getData" method="get" headers='{"X-Requested-With": "XMLHttpRequest"}'
			   url="/api/corp/monthly-report/costs"
      		      on-request="_startLoader"
		      on-response="_assignData">
	</iron-ajax>

	<form id="gridForm" is="iron-form"
	      content-type="application/json"
	      method="post"
	      action="/api/corp/monthly-report/costs"
       	      on-iron-form-presubmit="_parseDataBeforeSubmit"
	      on-iron-form-response="_submitResponse"
	      class="form-horizontal">

	<div class="row">
		<div class="col-xs-12 text-right">
			<template is="dom-if" if="{{adminMode}}">
				<button type="button" on-tap="_downloadExcel" class="btn btn-sm btn-default">엑셀 다운로드</button>
			</template>
			<template is="dom-if" if="{{!adminMode}}">
			<button type="button" on-tap="_resetData" class="btn btn-sm btn-default">되돌리기</button>
			<button type="button" on-tap="_submitForm" class="btn btn-sm btn-primary">저장</button>
			</template>
		</div>
	</div>

	<div id="alert" class="alert alert-dismissible hide" role="alert"></div>

	<div class="horizontal-margin-20"></div>

	<table id="tableExpense" class="table table-bordered">
		<thead>
			<tr>
				<th>비용</th>
				<th colspan='5'>비용현황</th>
				<th colspan='2'>적립금</th>
			</tr>
			<tr>
				<th>월</th>
				<th>식재료비</th>
				<th>인건비</th>
				<th>일반운영비</th>
				<th>감가상각비</th>
				<th>영업외비용</th>
				<th>월퇴직적립금</th>
				<th>자립적립금</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
		<tfoot>
		</tfoot>
	</table>
</form>

</template>
<script>
Polymer({
	is: 'report-expense',

	behaviors: [Lunch.GridBehavior, Lunch.LoaderBehavior],

	properties: {
		year: Number,
		adminMode: {
			type: Boolean,
			value: false
		},
		apiTrigger: {
			type: Boolean,
			value: false
		},
		_corpSeq: {
			type: Number,
			value: function() {
				return parseInt(sessionStorage.corpSeq);
			}
		},
		_data: {
			type: Array,
			value: function() {
				return [];
			}
		},
		_guide: {
			type: Array,
			value: function() {
				return [
					'FOOD_MATERIAL',
					'LABOR',
					'MANAGEMENT',
					'DEPRECIATION',
					'NON_SALES',
					'RETIRE_SAVING',
					'INDEPENDENCY_SAVING',
				];
			}
		},
	},

	observers: [
		'requestData(apiTrigger, _corpSeq, year)'
	],

	created: function() {
		this._adminAPIURL = '/api/hq/monthly-report/costs';
	},

	_clearData: function() {
		Polymer.dom(this.$.tableExpense.querySelector('tbody')).innerHTML = '';
		Polymer.dom(this.$.tableExpense.querySelector('tfoot')).innerHTML = '';
	},

	_assignData: function(e) {
		this._data = e.target.lastResponse;

		if (this._data) {
			this._assignDataToTable('expense', this.$.tableExpense, this._data, this._guide);
			this._stopLoader();
		}
	},

	_parseDataBeforeSubmit: function(e) {
		var data = this.$.gridForm.serialize();
		var parsedData = [];

		for (var i = 0; i < 12; i++) {
			for (var key in data) {
				var keySplit = key.split('_');
				var category = keySplit[0];
				var insertKey = keySplit.splice(1, keySplit.length).join('_');
				var insertValue = accounting.unformat(data[key][i]);

				if (!parsedData[i])
					parsedData[i] = {};
				parsedData[i][insertKey] = insertValue;
			}
			parsedData[i]['YEAR'] = this.year;
			parsedData[i]['CORP_SEQ'] = this._corpSeq;
			parsedData[i]['MONTH'] = i + 1;
		}

	   	this.$.gridForm.request.body = parsedData;
	},

});
</script>
</dom-module>
