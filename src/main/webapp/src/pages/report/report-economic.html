<link rel="import" href="/bower_components/iron-form/iron-form.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/src/components/common/number-input.html">
<link rel="import" href="/src/components/common/normal-select.html">
<link rel="import" href="/src/components/behaviors/behavior-grid.html">
<link rel="import" href="/src/components/behaviors/behavior-loader.html">

<dom-module id="report-economic">
<template>
	<iron-ajax id="getData" method="get" headers='{"X-Requested-With": "XMLHttpRequest"}'
			 on-request="_startLoader"
			   url="/api/corp/yearly-report/finance"
		      on-response="_assignData">
	</iron-ajax>
	<div class="horizontal-margin-20"></div>

	<form id="gridForm" is="iron-form"
	      content-type="application/json"
	      method="post" 
	      action="/api/corp/yearly-report/finance"
       	      on-iron-form-presubmit="_parseDataBeforeSubmit"
	      on-iron-form-response="_submitResponse"	
	      class="form-horizontal">

	<div class="row">
		<div class="col-xs-2">
			<normal-select name="year" value="{{year}}" items="{{_yearList}}"></normal-select>
		</div>
		<div class="col-xs-1">
			<button type="button" on-tap="requestData" class="btn btn-sm btn-primary">조회</button>
		</div>			
		<div class="col-xs-6 col-xs-offset-3 text-right">
			<template is="dom-if" if="{{adminMode}}">
				<button type="button" on-tap="_downloadExcel" class="btn btn-sm btn-default">엑셀 다운로드</button>
			</template>

			<button type="button" on-tap="_resetData" class="btn btn-sm btn-default">되돌리기</button>
			<button type="button" on-tap="_submitForm" class="btn btn-sm btn-primary">저장</button>
		</div>
	</div>
	
	<div id="alert" class="alert alert-dismissible hide" role="alert"></div>

	<div class="horizontal-margin-20"></div>

	<table id="tableGovSupply" class="table table-bordered">
		<thead>
			<tr>
				<th>비율</th>
				<th>매출액</th>
				<th>연평균인원</th>
				<th>인당 매출액</th>
				<th>영업이익률</th>
				<th>당기순이익율</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
		<tfoot>
		</tfoot>	
	</table>
	<table id="tableSelfSupply" class="table table-bordered">
		<thead>
			<tr>
				<th rowspan='2'>비율</th>
				<th colspan='3'>부채비율</th>
				<th colspan='3'>유동비율</th>
			</tr>
			<tr>
				<th>부채총액</th>
				<th>자기자본</th>
				<th>부채비율</th>
				<th>유동자신</th>
				<th>유동비율</th>
				<th>유동비율</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
		<tfoot>
		</tfoot>
	</table>

	</form>
</template>
<script>
Polymer({
	is: 'report-economic',

	behaviors: [Lunch.GridBehavior, Lunch.LoaderBehavior],

	properties: {
		_yearList: {
			type: Array,
			value: function() {
				var list = [];

				for (var i = 2013; i <= 2030; i++) {
					list.push({cdNm:i, cd:i});
				}

				return list;
			}
		},
		year: {
			type: Number,
			value: function() {
				return moment().year();
			}
		},
		adminMode: {
			type: Boolean,
			value: false
		},
		apiTrigger: {
			type: Boolean,
			value: false
		},
		_corpSeq: {
			type: Number,
			value: function() {
				return parseInt(sessionStorage.corpSeq);
			}
		},
		_data: {
			type: Array,
			value: function() {
				return [];
			}
		},
		_guideTop: {
			type: Array,
			value: function() {
				return [
					'TOTAL_SALES',
					'MANYEAR_AVG',
					'PER_SALES',
					'OP_PROFIT_RATE',
					'NET_PROFIT_RATE',
				];
			}
		},
		_guideBottom: {
			type: Array,
			value: function() {
				return [
					'TOTAL_DEBT',
					'EQUITY_CAPITAL',
					'DEBT_RATIO',
					'LIQUID_ASSETS',
					'TOTAL_ASSETS',
					'LIQUIDITY_RATIO',
				];
			}
		},
	},

	observers: [
		'requestData(apiTrigger, _corpSeq)'
	],

	created: function() {
		this._adminAPIURL = '/api/hq/yearly-report/finance';
	},

	_assignData: function(e) {
		this._data = e.target.lastResponse;

		if (this._data) {
			this._assignDataToTable('tableA', this.$.tableGovSupply, this._data, this._guideTop);
			this._assignDataToTable('tableB', this.$.tableSelfSupply, this._data, this._guideBottom);
			this._stopLoader();
		}
	},

	_clearData: function() {
		// gov
		Polymer.dom(this.$.tableGovSupply.querySelector('tbody')).innerHTML = '';
		Polymer.dom(this.$.tableGovSupply.querySelector('tfoot')).innerHTML = '';

		// self
		Polymer.dom(this.$.tableSelfSupply.querySelector('tbody')).innerHTML = '';
		Polymer.dom(this.$.tableSelfSupply.querySelector('tfoot')).innerHTML = '';

	},

	_assignDataToTable: function(prefix, table, data, guide) { 
		var body = table.querySelector('tbody');
		var tr, th, td, value;
		var input;
		var total = {};

		Polymer.dom(body).innerHTML = '';

		for (var i = 0; i < this._data.length; i++) {
			tr = document.createElement('tr');	
			th = document.createElement('th');
			Polymer.dom(th).innerHTML = data[i].YEAR;

			Polymer.dom(body).appendChild(tr);
			Polymer.dom(tr).appendChild(th);

			for (var attribute in guide) {
				td = document.createElement('td');
				Polymer.dom(tr).appendChild(td);

				value = data[i][guide[attribute]];

				input = document.createElement('number-input');
				input.setAttribute('transparent', true);
				input.setAttribute('id', prefix + '_' + guide[attribute] + i);
				input.setAttribute('name', prefix + '_' + guide[attribute]);
				input.setAttribute('value', value);

				if (guide[attribute] == 'PER_SALES' ||
				    guide[attribute] == 'DEBT_RATIO' ||
				    guide[attribute] == 'LIQUIDITY_RATIO') {
					input.setAttribute('value', 0);
					input.setAttribute('readonly', true);
				}
				Polymer.dom(td).appendChild(input);

				this.listen(input, 'value-changed', '_recalculateTotal');

				if (!total[guide[attribute]])
					total[guide[attribute]] = 0;

				total[guide[attribute]] += value;
			}

			// year
			value = data[i]['YEAR'];

			input = document.createElement('input');
			input.setAttribute('id', prefix + '_YEAR' + i);
			input.setAttribute('is', 'iron-input');
			input.setAttribute('name', prefix + '_YEAR');
			input.setAttribute('value', value);
			input.setAttribute('hidden', true);

			Polymer.dom(td).appendChild(input);
		}	

		this._drawFooter(prefix, table, total);
	},

	_drawFooter: function(prefix, table, total) {

		var foot = table.querySelector('tfoot');
		Polymer.dom(foot).innerHTML = '';

		if (!this._hideSum) {
			// sum
			tr = document.createElement('tr');
			th = document.createElement('th');
			Polymer.dom(th).innerHTML = '연평균';
			Polymer.dom(tr).appendChild(th);
			Polymer.dom(foot).appendChild(tr);

			for (var t in total) {
				td = document.createElement('td');
				td.setAttribute('id', 'sum_' + prefix + '_' + t);
				td.innerHTML = accounting.formatNumber(total[t] / 12);

				Polymer.dom(tr).appendChild(td);
			}
		}

	},

	_recalculateTotal: function(e) {
		var name = e.currentTarget.name;
		var prefix = name.split('_')[0];
		var columnName = name.split('_').slice(1, 10).join('_');
		var total = 0, sum;
		var a, b;

		for (var i = 0; i < this._data.length; i++) {
			total += this.$$("#"+name+i).number;

			switch (columnName) {
				case 'TOTAL_SALES':
				case 'MANYEAR_AVG':
					a = this.$$("#" + prefix + "_TOTAL_SALES" + i).number;
					b = this.$$("#" + prefix + "_MANYEAR_AVG" + i).number;
					this.$$("#" + prefix + "_PER_SALES" + i).value = accounting.formatNumber(a / b * 100);
					break;
				case 'TOTAL_DEBT':
				case 'EQUITY_CAPITAL':
					a = this.$$("#" + prefix + "_TOTAL_DEBT" + i).number;
					b = this.$$("#" + prefix + "_EQUITY_CAPITAL" + i).number;
					this.$$("#" + prefix + "_DEBT_RATIO" + i).value = accounting.formatNumber(a / b * 100);
					break;
				case 'LIQUID_ASSETS':
				case 'TOTAL_ASSETS':
					a = this.$$("#" + prefix + "_LIQUID_ASSETS" + i).number;
					b = this.$$("#" + prefix + "_TOTAL_ASSETS" + i).number;
					this.$$("#" + prefix + "_LIQUIDITY_RATIO" + i).value = accounting.formatNumber(a / b * 100);
					break;
			}
		}

		// set sum
		if (!this._hideSum)
			this.$$('#sum_' + name).innerHTML = accounting.formatNumber(total / 12);

		this._refreshHeaderTotal();
	},

	_parseDataBeforeSubmit: function(e) {
		var data = this.$.gridForm.serialize();
		var parsedData = [];

		for (var i = 0; i < this._data.length; i++) {
			for (var key in data) {
				var keySplit = key.split('_');
				var category = keySplit[0];
				var insertKey = keySplit.splice(1, keySplit.length).join('_');
				var insertValue = accounting.unformat(data[key][i]);


				if (!parsedData[i])
					parsedData[i] = {};
				parsedData[i][insertKey] = insertValue;

			}
			parsedData[i]['CORP_SEQ'] = this._corpSeq;

		}

	   	this.$.gridForm.request.body = parsedData;
	},


	
});
</script>
</dom-module>
